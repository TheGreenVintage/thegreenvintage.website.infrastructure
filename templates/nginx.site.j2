upstream app_server_{{ user }} {
  server unix:/home/{{ user }}/shared/{{ user }}.website.dynamic.sock fail_timeout=0;
}

upstream app_server_{{ user }}_next {
  server unix:/home/{{ user }}/shared/next.{{ user }}.website.dynamic.sock fail_timeout=0;
}

upstream app_jekyll_hook {
  server 127.0.0.1:8080 fail_timeout=0;
  # server unix:/home/{{ user }}/shared/{{ user }}.jekyll_hook.sock fail_timeout=0;
}

server {
  listen       80;
  server_name  {{ domain }};
  return       301 http://www.{{ domain }}$request_uri;
}

server {
  client_max_body_size 1G;
  server_name www.{{ domain }};
  keepalive_timeout 5;

  root /usr/share/nginx/html/{{ user }}.website.static;

  server_tokens off;
  add_header X-Frame-Options SAMEORIGIN;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
  add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://www.google-analytics.com; img-src 'self' http://www.google-analytics.com; style-src 'self' 'unsafe-inline' http://fonts.googleapis.com; font-src 'self' http://fonts.googleapis.com http://fonts.gstatic.com; frame-src 'none'; object-src 'none'";

  try_files $uri/index.html $uri.html $uri @app;

  location @app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://app_server_{{ user }};
  }

  location /hooks/jekyll/master {
    allow 192.30.252.130/24;
    deny all;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://app_jekyll_hook;
  }

  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root /usr/share/nginx/html/{{ user }}.website.static;
  }
}

server {
  client_max_body_size 1G;
  server_name next.{{ domain }};
  keepalive_timeout 5;

  root /usr/share/nginx/html/next.{{ user }}.website.static;

  server_tokens off;
  add_header X-Frame-Options SAMEORIGIN;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
  add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' http://www.google-analytics.com; img-src 'self' http://www.google-analytics.com; style-src 'self' 'unsafe-inline' http://fonts.googleapis.com; font-src 'self' http://fonts.googleapis.com http://fonts.gstatic.com; frame-src 'none'; object-src 'none'";

  try_files $uri/index.html $uri.html $uri @app;

  location @app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://app_server_{{ user }}_next;
  }

  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root /usr/share/nginx/html/next.{{ user }}.website.static;
  }
}
