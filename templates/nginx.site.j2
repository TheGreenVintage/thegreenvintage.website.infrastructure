upstream app_server {
  server unix:/home/{{ user }}/shared/{{ user }}.website.dynamic.sock fail_timeout=0;
}

upstream app_jekyll_hook {
  server 127.0.0.1:8080 fail_timeout=0;
  # server unix:/home/{{ user }}/shared/{{ user }}.jekyll_hook.sock fail_timeout=0;
}

server {
  listen       80;
  server_name  {{ domain }};
  return       301 http://www.{{ domain }}$request_uri;
}

server {
  client_max_body_size 1G;
  server_name www.{{ domain }};
  keepalive_timeout 5;

  root /usr/share/nginx/html/{{ user }}.website.static;

  try_files $uri/index.html $uri.html $uri @app;

  location @app {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://app_server;
  }

  location /hooks/jekyll/master {
    allow 192.30.252.130/24;
    deny all;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    proxy_pass http://app_jekyll_hook;
  }

  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root /usr/share/nginx/html/{{ user }}.website.static;
  }
}
