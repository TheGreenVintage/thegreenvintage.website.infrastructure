---

- hosts: all
  vars_files:
    - vars.yml
  remote_user: vagrant
  sudo: no

  tasks:

    - name: checkouts the dynamic repository
      git: repo=https://github.com/{{ github_user_name }}/{{ user }}.website.dynamic.git dest=/home/{{ user }}/{{ user }}.website.dynamic
      sudo_user: "{{ user }}"
      sudo: yes

    - name: checkouts the static repository
      git: repo=https://github.com/{{ github_user_name }}/{{ user }}.website.static.git dest=/home/{{ user }}/{{ user }}.website.static
      sudo_user: "{{ user }}"
      sudo: yes

    - name: checkouts the jekyll-hook repository
      git: repo=https://github.com/developmentseed/jekyll-hook.git dest=/home/{{ user }}/jekyll-hook
      sudo_user: "{{ user }}"
      sudo: yes

    - name: Writes the jekyll config
      template: src=templates/jekyll.j2 dest=/home/{{ user }}/jekyll-hook/conf.json mode=0644
      sudo_user: "{{ user }}"
      sudo: yes

    - name: Ensures that the shared folder is created
      action: file path=/home/{{ user }}/shared state=directory
      sudo_user: "{{ user }}"
      sudo: yes

    - name: Initializes bundle
      command: "pushd /home/{{ user }}/{{ user }}.website.static && bundle"

    - name: Build jekyll
      command: "pushd /home/{{ user }}/{{ user }}.website.static && bundle exec jekyll build"
      #trigger:
      # - restart nginx
